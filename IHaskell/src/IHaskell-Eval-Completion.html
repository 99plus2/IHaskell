<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/IHaskell/Eval/Completion.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE NoImplicitPrelude, OverloadedStrings #-}</span>
<a name="line-2"></a><span class='hs-comment'>{- |
<a name="line-3"></a>Description : Generates tab completion options.
<a name="line-4"></a>
<a name="line-5"></a>This has a limited amount of context sensitivity. It distinguishes between four contexts at the moment:
<a name="line-6"></a>- import statements (completed using modules)
<a name="line-7"></a>- identifiers (completed using in scope values)
<a name="line-8"></a>- extensions via :ext (completed using GHC extensions)
<a name="line-9"></a>- qualified identifiers (completed using in-scope values)
<a name="line-10"></a>
<a name="line-11"></a>-}</span>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>IHaskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Eval</span><span class='hs-varop'>.</span><span class='hs-conid'>Completion</span> <span class='hs-layout'>(</span><span class='hs-varid'>complete</span><span class='hs-layout'>,</span> <span class='hs-varid'>completionTarget</span><span class='hs-layout'>,</span> <span class='hs-varid'>completionType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CompletionType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;$&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>UTF8</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span><span class='hs-layout'>,</span> <span class='hs-varid'>take</span><span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>find</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPrefixOf</span><span class='hs-layout'>,</span> <span class='hs-varid'>nub</span><span class='hs-layout'>,</span> <span class='hs-varid'>findIndex</span><span class='hs-layout'>,</span> <span class='hs-varid'>intercalate</span><span class='hs-layout'>,</span> <span class='hs-varid'>elemIndex</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-varop'>.</span><span class='hs-conid'>Split</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-varop'>.</span><span class='hs-conid'>Split</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>String</span><span class='hs-varop'>.</span><span class='hs-conid'>Utils</span> <span class='hs-layout'>(</span><span class='hs-varid'>strip</span><span class='hs-layout'>,</span> <span class='hs-varid'>startswith</span><span class='hs-layout'>,</span> <span class='hs-varid'>replace</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GhcMonad</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PackageConfig</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>showPpr</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IHaskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-31"></a>
<a name="line-32"></a>
<a name="line-33"></a><a name="CompletionType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CompletionType</span> 
<a name="line-34"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Empty</span> 
<a name="line-35"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Identifier</span> <span class='hs-conid'>String</span>
<a name="line-36"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Extension</span> <span class='hs-conid'>String</span>
<a name="line-37"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Qualified</span> <span class='hs-conid'>String</span> <span class='hs-conid'>String</span>
<a name="line-38"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ModuleName</span> <span class='hs-conid'>String</span> <span class='hs-conid'>String</span>
<a name="line-39"></a>     <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="complete"></a><span class='hs-definition'>complete</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-definition'>complete</span> <span class='hs-varid'>line</span> <span class='hs-varid'>pos</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-43"></a>  <span class='hs-varid'>flags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSessionDynFlags</span>
<a name="line-44"></a>  <span class='hs-varid'>rdrNames</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>showPpr</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getRdrNamesInScope</span>
<a name="line-45"></a>  <span class='hs-varid'>scopeNames</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>showPpr</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getNamesInScope</span>
<a name="line-46"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>isQualified</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-chr'>'.'</span> <span class='hs-varop'>`elem`</span><span class='hs-layout'>)</span>
<a name="line-47"></a>      <span class='hs-varid'>unqualNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isQualified</span><span class='hs-layout'>)</span> <span class='hs-varid'>rdrNames</span>
<a name="line-48"></a>      <span class='hs-varid'>qualNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-varop'>$</span> <span class='hs-varid'>scopeNames</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isQualified</span> <span class='hs-varid'>rdrNames</span>
<a name="line-49"></a>
<a name="line-50"></a>  <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>db</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgDatabase</span> <span class='hs-varid'>flags</span>
<a name="line-51"></a>      <span class='hs-varid'>getNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-varop'>.</span> <span class='hs-varid'>exposedModules</span>
<a name="line-52"></a>      <span class='hs-varid'>moduleNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>getNames</span> <span class='hs-varid'>db</span>
<a name="line-53"></a>
<a name="line-54"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>completionTarget</span> <span class='hs-varid'>line</span> <span class='hs-varid'>pos</span>
<a name="line-55"></a>      <span class='hs-varid'>matchedText</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>intercalate</span> <span class='hs-str'>"."</span> <span class='hs-varid'>target</span>
<a name="line-56"></a>
<a name="line-57"></a>  <span class='hs-varid'>options</span> <span class='hs-keyglyph'>&lt;-</span> 
<a name="line-58"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>completionType</span> <span class='hs-varid'>line</span> <span class='hs-varid'>target</span> <span class='hs-keyword'>of</span>
<a name="line-59"></a>          <span class='hs-conid'>Empty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-60"></a>
<a name="line-61"></a>          <span class='hs-conid'>Identifier</span> <span class='hs-varid'>candidate</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-62"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>candidate</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>unqualNames</span>
<a name="line-63"></a>
<a name="line-64"></a>          <span class='hs-conid'>Qualified</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>candidate</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-65"></a>            <span class='hs-varid'>trueName</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTrueModuleName</span> <span class='hs-varid'>moduleName</span>
<a name="line-66"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>prefix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>intercalate</span> <span class='hs-str'>"."</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>trueName</span><span class='hs-layout'>,</span> <span class='hs-varid'>candidate</span><span class='hs-keyglyph'>]</span>
<a name="line-67"></a>                <span class='hs-varid'>completions</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>prefix</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span>  <span class='hs-varid'>qualNames</span>
<a name="line-68"></a>                <span class='hs-varid'>falsifyName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replace</span> <span class='hs-varid'>trueName</span> <span class='hs-varid'>moduleName</span>
<a name="line-69"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>falsifyName</span> <span class='hs-varid'>completions</span>
<a name="line-70"></a>
<a name="line-71"></a>          <span class='hs-conid'>ModuleName</span> <span class='hs-varid'>previous</span> <span class='hs-varid'>candidate</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-72"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>prefix</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>previous</span>
<a name="line-73"></a>                         <span class='hs-keyword'>then</span> <span class='hs-varid'>candidate</span>
<a name="line-74"></a>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>intercalate</span> <span class='hs-str'>"."</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>previous</span><span class='hs-layout'>,</span> <span class='hs-varid'>candidate</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>prefix</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>moduleNames</span>
<a name="line-76"></a>
<a name="line-77"></a>          <span class='hs-conid'>Extension</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-78"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>extName</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-79"></a>                <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>extName</span> <span class='hs-varid'>xFlags</span>
<a name="line-80"></a>                <span class='hs-varid'>nonames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-str'>"No"</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span>
<a name="line-81"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>ext</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>names</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nonames</span>
<a name="line-82"></a>
<a name="line-83"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>matchedText</span><span class='hs-layout'>,</span> <span class='hs-varid'>options</span><span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="getTrueModuleName"></a><span class='hs-definition'>getTrueModuleName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>String</span>
<a name="line-86"></a><span class='hs-definition'>getTrueModuleName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-87"></a>  <span class='hs-comment'>-- Only use the things that were actually imported</span>
<a name="line-88"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>onlyImportDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>IIDecl</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>decl</span>
<a name="line-89"></a>      <span class='hs-varid'>onlyImportDecl</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-90"></a>
<a name="line-91"></a>  <span class='hs-comment'>-- Get all imports that we use.</span>
<a name="line-92"></a>  <span class='hs-varid'>imports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catMaybes</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>map</span> <span class='hs-varid'>onlyImportDecl</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getContext</span>
<a name="line-93"></a>
<a name="line-94"></a>  <span class='hs-comment'>-- Find the ones that have a qualified name attached.</span>
<a name="line-95"></a>  <span class='hs-comment'>-- If this name isn't one of them, it already is the true name.</span>
<a name="line-96"></a>  <span class='hs-varid'>flags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSessionDynFlags</span>
<a name="line-97"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>qualifiedImports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ideclAs</span><span class='hs-layout'>)</span> <span class='hs-varid'>imports</span>
<a name="line-98"></a>      <span class='hs-varid'>hasName</span> <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-varid'>showPpr</span> <span class='hs-varid'>flags</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromJust</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ideclAs</span><span class='hs-layout'>)</span> <span class='hs-varid'>imp</span>
<a name="line-99"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>find</span> <span class='hs-varid'>hasName</span> <span class='hs-varid'>qualifiedImports</span> <span class='hs-keyword'>of</span>
<a name="line-100"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>name</span>  
<a name="line-101"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>trueImp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showPpr</span> <span class='hs-varid'>flags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unLoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ideclName</span> <span class='hs-varid'>trueImp</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="completionType"></a><span class='hs-definition'>completionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CompletionType</span>
<a name="line-104"></a><span class='hs-definition'>completionType</span> <span class='hs-varid'>line</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Empty</span>
<a name="line-105"></a><span class='hs-definition'>completionType</span> <span class='hs-varid'>line</span> <span class='hs-varid'>target</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>startswith</span> <span class='hs-str'>"import"</span> <span class='hs-varid'>stripped</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isModName</span>
<a name="line-107"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleName</span> <span class='hs-varid'>dotted</span> <span class='hs-varid'>candidate</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isModName</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>init</span><span class='hs-layout'>)</span> <span class='hs-varid'>target</span>
<a name="line-109"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Qualified</span> <span class='hs-varid'>dotted</span> <span class='hs-varid'>candidate</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>startswith</span> <span class='hs-str'>":e"</span> <span class='hs-varid'>stripped</span>
<a name="line-111"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Extension</span> <span class='hs-varid'>candidate</span> 
<a name="line-112"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-113"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Identifier</span> <span class='hs-varid'>candidate</span>
<a name="line-114"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>stripped</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strip</span> <span class='hs-varid'>line</span>
<a name="line-115"></a>        <span class='hs-varid'>dotted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dots</span> <span class='hs-varid'>target</span>
<a name="line-116"></a>        <span class='hs-varid'>candidate</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>last</span> <span class='hs-varid'>target</span>
<a name="line-117"></a>        <span class='hs-varid'>dots</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>intercalate</span> <span class='hs-str'>"."</span> <span class='hs-varop'>.</span> <span class='hs-varid'>init</span>
<a name="line-118"></a>        <span class='hs-varid'>isModName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isCapitalized</span> <span class='hs-layout'>(</span><span class='hs-varid'>init</span> <span class='hs-varid'>target</span><span class='hs-layout'>)</span>
<a name="line-119"></a>        <span class='hs-varid'>isCapitalized</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUpper</span> <span class='hs-varop'>.</span> <span class='hs-varid'>head</span>
<a name="line-120"></a>
<a name="line-121"></a>
<a name="line-122"></a><a name="completionTarget"></a><span class='hs-comment'>-- | Get the word under a given cursor location.</span>
<a name="line-123"></a><span class='hs-definition'>completionTarget</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-124"></a><span class='hs-definition'>completionTarget</span> <span class='hs-varid'>code</span> <span class='hs-varid'>cursor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expandCompletionPiece</span> <span class='hs-varid'>pieceToComplete</span>
<a name="line-125"></a>  <span class='hs-keyword'>where</span> 
<a name="line-126"></a>    <span class='hs-varid'>pieceToComplete</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-varid'>elem</span> <span class='hs-varid'>cursor</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>pieces</span>
<a name="line-127"></a>    <span class='hs-varid'>pieces</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAlongCursor</span> <span class='hs-varop'>$</span> <span class='hs-varid'>split</span> <span class='hs-varid'>splitter</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-keyglyph'>]</span>
<a name="line-128"></a>    <span class='hs-varid'>splitter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultSplitter</span> <span class='hs-layout'>{</span>
<a name="line-129"></a>      <span class='hs-comment'>-- Split using only the characters, which are the first elements of</span>
<a name="line-130"></a>      <span class='hs-comment'>-- the (char, index) tuple</span>
<a name="line-131"></a>      <span class='hs-varid'>delimiter</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Delimiter</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>isDelim</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-132"></a>      <span class='hs-comment'>-- Condense multiple delimiters into one and then drop them.</span>
<a name="line-133"></a>      <span class='hs-varid'>condensePolicy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Condense</span><span class='hs-layout'>,</span>
<a name="line-134"></a>      <span class='hs-varid'>delimPolicy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Drop</span>
<a name="line-135"></a>    <span class='hs-layout'>}</span>
<a name="line-136"></a>
<a name="line-137"></a>    <span class='hs-varid'>isDelim</span> <span class='hs-varid'>char</span> <span class='hs-varid'>idx</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>neverIdent</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isSymbol</span> <span class='hs-varid'>char</span>
<a name="line-138"></a>
<a name="line-139"></a>    <span class='hs-varid'>splitAlongCursor</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Char</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Char</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-140"></a>    <span class='hs-varid'>splitAlongCursor</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-141"></a>    <span class='hs-varid'>splitAlongCursor</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-142"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>elemIndex</span> <span class='hs-varid'>cursor</span> <span class='hs-varop'>$</span>  <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>of</span>
<a name="line-143"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>splitAlongCursor</span> <span class='hs-varid'>xs</span>
<a name="line-144"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>idx</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>take</span> <span class='hs-layout'>(</span><span class='hs-varid'>idx</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>drop</span> <span class='hs-layout'>(</span><span class='hs-varid'>idx</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>splitAlongCursor</span> <span class='hs-varid'>xs</span>
<a name="line-145"></a>
<a name="line-146"></a>    <span class='hs-comment'>-- These are never part of an identifier.</span>
<a name="line-147"></a>    <span class='hs-varid'>neverIdent</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>" \n\t(),{}[]\\'\"`"</span>
<a name="line-148"></a>
<a name="line-149"></a>    <span class='hs-varid'>expandCompletionPiece</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-150"></a>    <span class='hs-varid'>expandCompletionPiece</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitOn</span> <span class='hs-str'>"."</span> <span class='hs-varid'>str</span> 
</pre></body>
</html>
